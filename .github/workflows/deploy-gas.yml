name: Deploy to Google Apps Script

on:
  # æ‰‹å‹•ã§ã®ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆã‚’è¨±å¯
  workflow_dispatch:
    inputs:
      description:
        description: 'Deployment description'
        required: false
        default: 'Manual deployment triggered.'
  # pull_request (closedã‹ã¤merged) ã®ã¿ã§è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’ãƒˆãƒªã‚¬ãƒ¼
  pull_request:
    types: [closed]
    branches: [main]
  # æ³¨æ„: ã‚‚ã— push ã§ãƒ‡ãƒ—ãƒ­ã‚¤ã—ãŸã„å ´åˆã¯ pull_request ã‚’å‰Šé™¤ã—ã€
  # push: { branches: [main] } ã®ã¿ã«ã—ã¦ãã ã•ã„ã€‚
  # ãã†ã—ãªã„ã¨ã€pull_request ãƒãƒ¼ã‚¸æ™‚ã¨ main ã¸ã® push æ™‚ã§äºŒé‡ã«ãƒˆãƒªã‚¬ãƒ¼ã•ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚


jobs:
  deploy:
    # workflow_dispatch ã¾ãŸã¯ãƒãƒ¼ã‚¸ã•ã‚ŒãŸãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®å ´åˆã«å®Ÿè¡Œ
    if: github.event_name == 'workflow_dispatch' || (github.event_name == 'pull_request' && github.event.pull_request.merged == true)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20' # LTS ãƒãƒ¼ã‚¸ãƒ§ãƒ³ 20 ã‚’ä½¿ç”¨
          cache: 'npm'       # npm ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’æœ‰åŠ¹ã«ã—ã¦ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚’é«˜é€ŸåŒ–

      - name: Install dependencies
        run: npm ci # package-lock.json ã«åŸºã¥ã„ã¦ä¾å­˜é–¢ä¿‚ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

      - name: Install clasp globally
        # clasp ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ãŸã‚ã«ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãŒå¿…è¦
        run: npm install -g @google/clasp

      - name: Setup clasp credentials (from Base64 Secret)
        # GitHub Secretsã« CLASPRC_JSON_BASE64 (Base64ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã•ã‚ŒãŸ.clasprc.jsonã®å†…å®¹) ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’å‰æã¨ã—ã¾ã™ã€‚
        # Base64ãƒ‡ã‚³ãƒ¼ãƒ‰ã—ã¦ ~/.clasprc.json ã«æ›¸ãå‡ºã—ã¾ã™ã€‚
        run: |
          echo "${{ secrets.CLASPRC_JSON_BASE64 }}" | base64 -d > ~/.clasprc.json

      - name: Determine deployment description
        id: set-desc # å¾Œç¶šã‚¹ãƒ†ãƒƒãƒ—ã§å‡ºåŠ›ã‚’å‚ç…§ã™ã‚‹ãŸã‚ã«IDã‚’ä»˜ä¸
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "desc=${{ github.event.inputs.description }}" >> "$GITHUB_OUTPUT"
          else
            # PRãƒãƒ¼ã‚¸æ™‚ã®è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤ã®å ´åˆã€PRç•ªå·ã¨ã‚¿ã‚¤ãƒˆãƒ«ã‚’èª¬æ˜ã«å«ã‚ã‚‹
            echo "desc=Auto deployment from PR #${{ github.event.pull_request.number }} (${{ github.event.pull_request.title }})" >> "$GITHUB_OUTPUT"
          fi

      - name: Push code to Google Apps Script
        # ãƒ­ãƒ¼ã‚«ãƒ«ã®ã‚³ãƒ¼ãƒ‰ã‚’GASãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆï¼ˆã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚¨ãƒ‡ã‚£ã‚¿ã®å†…å®¹ï¼‰ã«åŒæœŸã™ã‚‹
        run: |
          set -e # ã‚³ãƒãƒ³ãƒ‰ãŒå¤±æ•—ã—ãŸå ´åˆã€ã™ãã«ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’çµ‚äº†
          npx clasp push

      - name: Create new version
        id: create-version # ä½œæˆã•ã‚ŒãŸãƒãƒ¼ã‚¸ãƒ§ãƒ³ç•ªå·ã‚’å–å¾—ã™ã‚‹ãŸã‚ã«IDã‚’ä»˜ä¸
        run: |
          set -e
          VERSION_DESCRIPTION="${{ steps.set-desc.outputs.desc }}"

          # clasp version ã‚³ãƒãƒ³ãƒ‰ã®å‡ºåŠ›ã‚’ãƒ‘ãƒ¼ã‚¹ã—ã¦ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç•ªå·ã‚’å–å¾—
          # å‡ºåŠ›ä¾‹: "Created version 130" ï¼ˆå‰å›ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã§ç¢ºèªæ¸ˆã¿ï¼‰
          VERSION_OUTPUT=$(npx clasp version "${VERSION_DESCRIPTION}")
          echo "Clasp Version Output: $VERSION_OUTPUT" # ãƒ‡ãƒãƒƒã‚°ç”¨ã¨ã—ã¦ãƒ­ã‚°ã«å‡ºåŠ›

          # "Created version XXX" ã‹ã‚‰ XXX ã‚’æŠ½å‡ºã™ã‚‹æ­£è¦è¡¨ç¾
          VERSION_NUMBER=$(echo "$VERSION_OUTPUT" | sed -n 's/^Created version \([0-9]\+\)$/\1/p')

          if [ -z "$VERSION_NUMBER" ]; then
            echo "::error::Failed to extract version number from clasp output. Please check clasp version command output format."
            exit 1 # ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç•ªå·ãŒå–å¾—ã§ããªã„å ´åˆã¯ã‚¨ãƒ©ãƒ¼ã§çµ‚äº†
          fi
          echo "version_number=$VERSION_NUMBER" >> "$GITHUB_OUTPUT" # å¾Œç¶šã‚¹ãƒ†ãƒƒãƒ—ã§åˆ©ç”¨ã§ãã‚‹ã‚ˆã†å‡ºåŠ›
          echo "Created new version: $VERSION_NUMBER with description: $VERSION_DESCRIPTION"

      - name: Deploy to Google Apps Script (Update existing Web App/API Executable)
        # æ—¢å­˜ã®ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆï¼ˆWebã‚¢ãƒ—ãƒªã‚„APIå®Ÿè¡Œå¯èƒ½URLãªã©ï¼‰ã‚’ã€æ–°ã—ãä½œæˆã—ãŸãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«æ›´æ–°ã™ã‚‹
        run: |
          set -e
          DESC="${{ steps.set-desc.outputs.desc }}"
          VERSION_TO_DEPLOY="${{ steps.create-version.outputs.version_number }}" # ç›´å‰ã§ä½œæˆã—ãŸãƒãƒ¼ã‚¸ãƒ§ãƒ³ç•ªå·ã‚’å–å¾—

          # GitHub Secretsã‹ã‚‰Webã‚¢ãƒ—ãƒªã®ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆIDã‚’å–å¾—
          # ã“ã® Secret ãŒè¨­å®šã•ã‚Œã¦ã„ãªã„å ´åˆã€è­¦å‘ŠãŒå‡ºåŠ›ã•ã‚Œã€æ—¢å­˜ã®Webã‚¢ãƒ—ãƒªURLã¯æ›´æ–°ã•ã‚Œãªã„
          # Webã‚¢ãƒ—ãƒªã®ãƒ‡ãƒ—ãƒ­ã‚¤IDã¯ GASã‚¨ãƒ‡ã‚£ã‚¿ã®ã€Œãƒ‡ãƒ—ãƒ­ã‚¤ã€->ã€Œãƒ‡ãƒ—ãƒ­ã‚¤ã‚’ç®¡ç†ã€ã§ç¢ºèªã§ãã¾ã™
          DEPLOYMENT_ID="${{ secrets.GAS_WEBAPP_DEPLOYMENT_ID }}" 

          if [ -z "$DEPLOYMENT_ID" ]; then
            echo "::warning::GAS_WEBAPP_DEPLOYMENT_ID secret is not set. Cannot update a specific existing deployment."
            echo "This workflow will create a new 'Head' deployment if no specific deploymentId is provided."
            echo "To update your existing Web App URL, please set GAS_WEBAPP_DEPLOYMENT_ID secret."
            # ç‰¹å®šã®ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆIDãŒãªã„å ´åˆã¯ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆé€šå¸¸ã¯æœ€æ–°ã‚³ãƒ¼ãƒ‰ã‚’æŒ‡ã™HEADãƒ‡ãƒ—ãƒ­ã‚¤ï¼‰
            # ã“ã‚Œã ã¨ã€æ—¢å­˜ã®Webã‚¢ãƒ—ãƒªURLã¯æ›´æ–°ã•ã‚Œãªã„ç‚¹ã«æ³¨æ„
            npx clasp deploy --description "$DESC"
          else
            echo "Updating existing deployment: $DEPLOYMENT_ID to version $VERSION_TO_DEPLOY"
            # æ—¢å­˜ã®ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆIDã‚’æŒ‡å®šã—ã€æ–°ã—ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ç´ã¥ã‘ã‚‹
            npx clasp deploy --deploymentId "$DEPLOYMENT_ID" --version "$VERSION_TO_DEPLOY" --description "$DESC"
          fi

      - name: Show current deployments
        # ç¾åœ¨ã®ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆã®ä¸€è¦§ã‚’è¡¨ç¤ºã—ã€ãƒ‡ãƒãƒƒã‚°ã«å½¹ç«‹ã¦ã‚‹
        run: npx clasp deployments

      - name: Notify deployment success
        # ãƒ‡ãƒ—ãƒ­ã‚¤æˆåŠŸã®é€šçŸ¥ã¨ã€GASãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¸ã®ç›´æ¥ãƒªãƒ³ã‚¯ã‚’è¡¨ç¤º
        run: |
          echo "âœ… Deployment completed successfully!"
          # .clasp.json ã‹ã‚‰ scriptId ã‚’ç›´æ¥å–å¾—ã—ã¦GASãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆURLã‚’ç”Ÿæˆ
          # grep ã¨ sed ã‚’ä½¿ã£ã¦ã‚¹ã‚¯ãƒªãƒ—ãƒˆIDã‚’æŠ½å‡º
          SCRIPT_ID=$(grep '"scriptId":' .clasp.json | head -n 1 | sed 's/.*"scriptId": "\(.*\)".*/\1/')

          if [ -n "$SCRIPT_ID" ]; then
            echo "ğŸ”— View your GAS project: https://script.google.com/d/${SCRIPT_ID}/edit"
          else
            echo "ğŸ”— View your GAS project: https://script.google.com"
            echo "âš ï¸ Could not determine Script ID. Please check .clasp.json."
          fi 